<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Weather — Forecast TTS (AI Optional) · Home Assistant Blueprint</title>
<meta name="description" content="Extensive documentation for the Weather — Forecast TTS (AI Optional) Home Assistant blueprint. Covers features, setup, inputs, triggers, AI rephrasing, webhooks, troubleshooting, and repository layout." />

<style>
  :root{
    --bg: #0b0e14;
    --bg-soft:#121826;
    --card:#0f1629;
    --muted:#9aa4b2;
    --text:#e6edf3;
    --brand:#60a5fa;
    --brand-2:#34d399;
    --border:#1f2940;
    --code-bg:#0b1220;
    --warn:#f59e0b;
    --ok:#22c55e;
    --err:#ef4444;
    --shadow: 0 8px 30px rgba(0,0,0,.35);
    --radius: 14px;
  }
  @media (prefers-color-scheme: light){
    :root{
      --bg:#f6f8fb; --bg-soft:#ffffff; --card:#ffffff; --muted:#5b6573;
      --text:#0b1220; --brand:#2563eb; --brand-2:#0ea5e9; --border:#dfe6ef;
      --code-bg:#0f172a; --shadow: 0 12px 28px rgba(16,24,40,.12);
    }
  }
  html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font:16px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Arial,Helvetica,sans-serif}
  a{color:var(--brand);text-decoration:none} a:hover{text-decoration:underline}
  .container{max-width:1100px;margin:0 auto;padding:24px}
  header.hero{
    position:relative; overflow:hidden; border-bottom:1px solid var(--border);
    background: radial-gradient(1000px 500px at 20% -10%, rgba(96,165,250,.25), transparent 60%),
                radial-gradient(900px 600px at 100% 10%, rgba(52,211,153,.18), transparent 60%),
                linear-gradient(0deg, rgba(255,255,255,.03), rgba(255,255,255,.03));
  }
  .hero-inner{display:grid;grid-template-columns:1.2fr .8fr;gap:28px;align-items:center;padding:48px 24px}
  .hero h1{font-size:40px;margin:0 0 12px 0;letter-spacing:.2px}
  .hero p{margin:0 0 16px 0;color:var(--muted)}
  .cta-row{display:flex;gap:12px;flex-wrap:wrap;margin-top:10px}
  .btn{
    display:inline-flex;align-items:center;gap:8px;
    background:var(--brand);color:white;border-radius:12px;padding:12px 16px;
    font-weight:600;border:0;box-shadow:var(--shadow);cursor:pointer
  }
  .btn.secondary{background:transparent;color:var(--brand);border:1px solid var(--brand)}
  .badge{display:inline-block;padding:2px 10px;border-radius:999px;font-size:12px;background:rgba(96,165,250,.15);color:var(--brand);border:1px solid rgba(96,165,250,.35);margin-right:10px}
  .grid{display:grid;gap:20px}
  .cards{grid-template-columns:repeat(12,1fr)}
  .card{grid-column:span 12;background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:18px}
  @media (min-width:920px){ .card.span-6{grid-column:span 6} .card.span-4{grid-column:span 4} }
  h2{font-size:28px;margin:8px 0 12px}
  h3{font-size:20px;margin:18px 0 8px}
  section{margin:28px 0}
  .muted{color:var(--muted)}
  details{border:1px solid var(--border);border-radius:12px;padding:12px 14px;background:var(--bg-soft)}
  details + details{margin-top:12px}
  summary{cursor:pointer;font-weight:600}
  code,kbd{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
  pre{background:var(--code-bg);color:#c9e3ff;border-radius:12px;padding:14px;overflow:auto;border:1px solid #0b1b3a;margin:12px 0}
  .code-row{display:flex;justify-content:space-between;align-items:center;margin-top:6px}
  .copy{background:transparent;border:1px solid var(--border);color:var(--muted);border-radius:10px;padding:6px 10px;font-size:13px;cursor:pointer}
  .toc{position:sticky;top:14px}
  .toc a{display:block;padding:6px 0;color:var(--muted)}
  .toc a.active{color:var(--brand);font-weight:700}
  .callout{border-left:4px solid var(--brand);background:rgba(96,165,250,.08);padding:12px 14px;border-radius:8px}
  .callout.warn{border-left-color:var(--warn);background:rgba(245,158,11,.08)}
  .callout.err{border-left-color:var(--err);background:rgba(239,68,68,.08)}
  .kpi{display:flex;gap:14px;flex-wrap:wrap;margin-top:10px}
  .pill{padding:8px 12px;border:1px solid var(--border);border-radius:999px;background:var(--bg-soft);color:var(--muted)}
  footer{border-top:1px solid var(--border);margin-top:40px;padding:24px;color:var(--muted)}
  .two-col{display:grid;grid-template-columns:1fr;gap:22px}
  @media (min-width:980px){.two-col{grid-template-columns:280px 1fr}}
  .table{width:100%;border-collapse:separate;border-spacing:0 8px}
  .table th,.table td{padding:10px 12px;vertical-align:top}
  .table th{color:var(--muted);font-weight:600}
  .row{background:var(--bg-soft);border:1px solid var(--border);border-radius:10px}
  .row td:first-child{border-top-left-radius:10px;border-bottom-left-radius:10px}
  .row td:last-child{border-top-right-radius:10px;border-bottom-right-radius:10px}
  .tag{display:inline-block;font-size:12px;padding:2px 8px;border:1px solid var(--border);border-radius:999px;color:var(--muted);margin-right:6px}
  .right{float:right}
</style>
</head>
<body>

<header class="hero">
  <div class="container hero-inner">
    <div>
      <span class="badge">Home Assistant Blueprint</span>
      <h1>Weather — Forecast TTS <span class="muted">(AI Optional)</span></h1>
      <p>
        Speak compact, TV-style forecasts to one or more speakers on a schedule or on demand.
        Uses daily + hourly data, calls out the first likely rain/snow window, and can run the message through an AI Task while preserving facts.
      </p>
      <div class="cta-row">
        <a class="btn" href="homeassistant://blueprint/import?url=https://raw.githubusercontent.com/zodyking/weather-forecast-alert-blueprint/refs/heads/main/weather-forecast.yaml">Import to Home Assistant</a>
        <a class="btn secondary" href="https://raw.githubusercontent.com/zodyking/weather-forecast-alert-blueprint/refs/heads/main/weather-forecast.yaml" target="_blank" rel="noopener">View raw YAML</a>
        <a class="btn secondary" href="https://github.com/zodyking/weather-forecast-alert-blueprint" target="_blank" rel="noopener">Repository</a>
      </div>
      <div class="kpi">
        <span class="pill">Multi-trigger: schedule, sensor, webhook, voice</span>
        <span class="pill">Per-scenario volume + pre-roll</span>
        <span class="pill">Optional AI rephrase</span>
      </div>
    </div>
    <div>
      <img alt="Blueprint banner" src="./imageforecast.png" style="width:100%;border-radius:16px;border:1px solid var(--border);box-shadow:var(--shadow)" />
    </div>
  </div>
</header>

<main class="container two-col">
  <nav class="toc">
    <h3>On this page</h3>
    <a href="#overview">Overview</a>
    <a href="#requirements">Requirements</a>
    <a href="#quickstart">Quick start</a>
    <a href="#inputs">Inputs</a>
    <a href="#triggers">Triggers & logic</a>
    <a href="#speech">How the speech is built</a>
    <a href="#ai">AI rephrasing</a>
    <a href="#webhook">Webhook usage</a>
    <a href="#voice">Voice satellite</a>
    <a href="#troubleshooting">Troubleshooting</a>
    <a href="#advanced">Advanced tips</a>
    <a href="#repo">Repository layout</a>
    <a href="#privacy">Privacy</a>
    <a href="#support">Support</a>
  </nav>

  <div>

    <section id="overview">
      <h2>Overview</h2>
      <div class="callout">
        This blueprint fetches daily and hourly forecasts from your chosen <code>weather</code> entity, crafts a short forecast, optionally sends it through an AI Task that preserves facts, then speaks it on selected speakers.
      </div>
      <div class="grid cards">
        <div class="card span-6">
          <h3>Key features</h3>
          <ul>
            <li>Concise, natural forecast with greeting, “right now”, today’s high/low.</li>
            <li>Mentions the first precipitation window within a look-ahead period with time and %.</li>
            <li>Multiple trigger modes: schedule, sensor, “upcoming change”, “current change”, webhook, voice command.</li>
            <li>Per-scenario volume and pre-roll to avoid clipped audio.</li>
            <li>Optional AI rephrasing via your AI Task entity.</li>
          </ul>
        </div>
        <div class="card span-6">
          <h3>Good to know</h3>
          <ul>
            <li>Precip mention needs hourly probability from your provider.</li>
            <li>If your speaker clips the first word, increase <em>TTS pre-roll</em>.</li>
            <li>For speaker groups, test a single device first for reliability.</li>
            <li>You control wording length via the AI prompt, or disable AI entirely.</li>
          </ul>
        </div>
      </div>
    </section>

    <section id="requirements">
      <h2>Requirements</h2>
      <ul>
        <li>A <code>weather</code> entity that supports <code>weather.get_forecasts</code> with <strong>daily</strong> and <strong>hourly</strong> data.</li>
        <li>A configured <strong>TTS</strong> engine entity and at least one <strong>media_player</strong>.</li>
        <li>Optional: an <strong>AI Task</strong> entity for rephrasing.</li>
        <li>Optional: the <strong>Conversation</strong> integration if you use voice phrases.</li>
      </ul>
    </section>

    <section id="quickstart">
      <h2>Quick start</h2>
      <ol>
        <li>Click <em>Import to Home Assistant</em> above and create an automation from the blueprint.</li>
        <li>Pick your <strong>Weather Entity</strong> and <strong>TTS engine</strong>. Add one or more <strong>Speakers</strong>.</li>
        <li>Decide which triggers you want: schedule, sensor, webhook, voice, change alerts.</li>
        <li>(Optional) Enable AI rephrasing and keep the default prompt, or tailor it.</li>
        <li>Test via the schedule or sensor. Raise <em>TTS pre-roll</em> if audio starts mid-word.</li>
      </ol>
      <div class="code-row">
        <span class="muted">Direct YAML import URL</span>
        <button class="copy" data-copy="https://raw.githubusercontent.com/zodyking/weather-forecast-alert-blueprint/refs/heads/main/weather-forecast.yaml">Copy</button>
      </div>
      <pre><code>https://raw.githubusercontent.com/zodyking/weather-forecast-alert-blueprint/refs/heads/main/weather-forecast.yaml</code></pre>
    </section>

    <section id="inputs">
      <h2>Inputs</h2>

      <details open>
        <summary>Weather Data</summary>
        <table class="table">
          <tr class="row"><td><strong>weather_entity</strong></td><td>Weather entity that provides current, daily, and hourly forecast data.</td></tr>
        </table>
      </details>

      <details open>
        <summary>TTS Settings</summary>
        <table class="table">
          <tr class="row"><td><strong>tts_engine</strong></td><td>TTS engine entity (e.g., Piper, Google Translate TTS).</td></tr>
          <tr class="row"><td><strong>speakers</strong></td><td>One or more <code>media_player</code> entities to speak on.</td></tr>
          <tr class="row"><td><strong>voice</strong></td><td>Voice identifier accepted by your TTS engine.</td></tr>
          <tr class="row"><td><strong>volume_level</strong></td><td>Default volume for time/sensor/voice runs (0-1).</td></tr>
          <tr class="row"><td><strong>preroll_ms</strong></td><td>Milliseconds to wait before speaking so the speaker wakes cleanly.</td></tr>
        </table>
      </details>

      <details>
        <summary>AI Rephrasing (Optional)</summary>
        <table class="table">
          <tr class="row"><td><strong>ai_task_entity</strong></td><td>AI Task entity to rephrase the crafted message.</td></tr>
          <tr class="row"><td><strong>use_ai_rewrite</strong></td><td>Enable or disable AI pass-through.</td></tr>
          <tr class="row"><td><strong>ai_rewrite_prompt</strong></td><td>Strict prompt that enforces factual integrity and output style.</td></tr>
        </table>
      </details>

      <details>
        <summary>Time-Based Announcements</summary>
        <table class="table">
          <tr class="row"><td><strong>enable_time_based</strong></td><td>Master toggle for scheduled runs.</td></tr>
          <tr class="row"><td><strong>hour_pattern</strong></td><td>Every /1, /2, /3 … hours.</td></tr>
          <tr class="row"><td><strong>minute_offset</strong></td><td>Minute within the hour to fire.</td></tr>
          <tr class="row"><td><strong>start_time</strong> / <strong>end_time</strong></td><td>Time window for scheduled runs.</td></tr>
          <tr class="row"><td><strong>days_of_week</strong></td><td>Limit to specific days; if none chosen, runs daily.</td></tr>
        </table>
      </details>

      <details>
        <summary>Sensor Trigger Announcements</summary>
        <table class="table">
          <tr class="row"><td><strong>enable_sensor_triggered</strong></td><td>Master toggle for sensor-based runs.</td></tr>
          <tr class="row"><td><strong>presence_sensors</strong></td><td>Binary sensors; trigger when they turn to <code>on</code>.</td></tr>
        </table>
      </details>

      <details>
        <summary>Alarm-Based Announcement (Webhook)</summary>
        <table class="table">
          <tr class="row"><td><strong>enable_alarm_announce</strong></td><td>Enable webhook-driven runs, e.g., wake-up.</td></tr>
          <tr class="row"><td><strong>webhook_id</strong></td><td>Used as <code>/api/webhook/{webhook_id}</code>.</td></tr>
          <tr class="row"><td><strong>personal_name</strong></td><td>Personal greeting name.</td></tr>
          <tr class="row"><td><strong>alarm_volume_level</strong></td><td>Volume for the webhook run.</td></tr>
        </table>
      </details>

      <details>
        <summary>Change Announcements</summary>
        <table class="table">
          <tr class="row"><td><strong>enable_current_change_announce</strong></td><td>Announce when the current weather state changes.</td></tr>
          <tr class="row"><td><strong>current_change_volume_level</strong></td><td>Volume for current-change announcements.</td></tr>
          <tr class="row"><td><strong>enable_upcoming_change_announce</strong></td><td>Announce approaching precipitation within a window.</td></tr>
          <tr class="row"><td><strong>upcoming_change_volume_level</strong></td><td>Volume for upcoming-change announcements.</td></tr>
          <tr class="row"><td><strong>minutes_before_announce</strong></td><td>Announce if precip starts within this many minutes.</td></tr>
        </table>
      </details>

      <details>
        <summary>Precipitation Settings</summary>
        <table class="table">
          <tr class="row"><td><strong>precip_threshold</strong> (%)</td><td>Minimum probability to mention precip.</td></tr>
          <tr class="row"><td><strong>hours_ahead</strong></td><td>How many upcoming hours to scan for precip.</td></tr>
        </table>
      </details>

      <details>
        <summary>Voice Satellite</summary>
        <table class="table">
          <tr class="row"><td><strong>enable_voice_satellite</strong></td><td>Respond to phrases via Conversation.</td></tr>
          <tr class="row"><td><strong>conversation_command</strong></td><td>One trigger phrase per line.</td></tr>
        </table>
      </details>
    </section>

    <section id="triggers">
      <h2>Triggers &amp; logic</h2>
      <ul>
        <li><strong>Time-based:</strong> Every <em>hour_pattern</em> hours at <em>minute_offset</em>, within <em>start_time–end_time</em> and selected <em>days_of_week</em>.</li>
        <li><strong>Sensor-triggered:</strong> When any selected sensor turns <code>on</code>.</li>
        <li><strong>Current change:</strong> When the <code>weather</code> entity’s state changes (e.g., clear → rainy).</li>
        <li><strong>Upcoming change:</strong> Every 5 minutes, checks hourly forecast and announces if precip is due within <em>minutes_before_announce</em>, and it is not precipitating now.</li>
        <li><strong>Webhook:</strong> Call <code>/api/webhook/{webhook_id}</code> to run a personal morning-style report.</li>
        <li><strong>Voice satellite:</strong> Conversation phrases listed in <em>conversation_command</em>.</li>
      </ul>
    </section>

    <section id="speech">
      <h2>How the speech is built</h2>
      <ol>
        <li>Fetch <strong>daily</strong> and <strong>hourly</strong> forecasts from your entity.</li>
        <li>Craft a short text:
          <ul>
            <li>Greeting + day name.</li>
            <li>Right now: condition, temperature, humidity (if available).</li>
            <li>Today: expected condition if it differs from “now”, high, low.</li>
            <li>First precip window within <em>hours_ahead</em> with daypart/time and probability.</li>
          </ul>
        </li>
        <li>(Optional) Send to AI Task using a strict prompt that preserves facts.</li>
        <li>Set volume, wait <em>preroll_ms</em>, call <code>tts.speak</code> on each speaker.</li>
      </ol>
    </section>

    <section id="ai">
      <h2>AI rephrasing</h2>
      <p>When enabled, the crafted message is sent to your <em>AI Task</em> entity. The default prompt enforces:</p>
      <ul>
        <li>Do not alter any numbers, units, times, or day names.</li>
        <li>2–4 short sentences, ≤ 55 words, plain vocabulary.</li>
        <li>No code blocks, quotes, or preambles.</li>
      </ul>
      <div class="callout warn">
        If you require fully local processing, turn off “Use AI Rewrite”.
      </div>
    </section>

    <section id="webhook">
      <h2>Webhook usage</h2>
      <p>Enable the “Alarm Based Announcement” inputs and set a <code>webhook_id</code>. Then call:</p>
      <pre><code>POST https://YOUR_HA_HOST/api/webhook/&lt;webhook_id&gt;</code></pre>
      <p>No body is required. The blueprint generates a personal, morning-style report using <em>personal_name</em> and <em>alarm_volume_level</em>.</p>
    </section>

    <section id="voice">
      <h2>Voice satellite</h2>
      <p>Enable “Voice Satellite”, then add one phrase per line in <em>conversation_command</em>, such as:</p>
      <pre><code>What's the weather
What is the weather
Give me the forecast</code></pre>
      <p>Ask your assistant the phrase. The automation responds with the forecast text and will speak it when configured to do so.</p>
    </section>

    <section id="troubleshooting">
      <h2>Troubleshooting</h2>

      <details open>
        <summary>First words are clipped</summary>
        <p>Increase <strong>TTS pre-roll</strong> to 250–400 ms.</p>
      </details>

      <details>
        <summary>No audio plays</summary>
        <ul>
          <li>Ensure <em>tts_engine</em> is configured and the <em>media_player</em> entities are reachable.</li>
          <li>Test a manual <code>tts.speak</code> call in Developer Tools.</li>
          <li>Try a single speaker instead of a group to isolate issues.</li>
        </ul>
      </details>

      <details>
        <summary>“Forecast not available.”</summary>
        <p>Your provider may not expose the required attributes or the entity is unavailable. Confirm the <code>weather</code> entity supports daily and hourly forecasts.</p>
      </details>

      <details>
        <summary>Precipitation line never appears</summary>
        <ul>
          <li>Your provider may not include <em>precipitation_probability</em> in the hourly data.</li>
          <li>Lower <strong>precip_threshold</strong> or extend <strong>hours_ahead</strong>.</li>
        </ul>
      </details>

      <details>
        <summary>Conversation command does nothing</summary>
        <p>Enable the Conversation integration and ensure your phrase matches exactly, one per line.</p>
      </details>

      <details>
        <summary>Template/Jinja errors</summary>
        <p>Avoid editing the template unless necessary. Every <code>{% set ... %}</code> must close with <code>%}</code>, and each <code>{{ ... }}</code> must resolve to valid values.</p>
      </details>
    </section>

    <section id="advanced">
      <h2>Advanced tips</h2>
      <ul>
        <li><strong>Tuning length:</strong> Keep AI enabled and reduce verbosity in the prompt, or disable AI to read the raw crafted message.</li>
        <li><strong>Per-scenario volume:</strong> Use different volumes for time/sensor, upcoming change, current change, and webhook announcements.</li>
        <li><strong>Speaker groups:</strong> If your group is inconsistent, run the repeat loop across devices instead of a single group target.</li>
      </ul>
    </section>

    <section id="repo">
      <h2>Repository layout</h2>
      <p>The production blueprint file lives at the repo root:</p>
      <pre><code>/weather-forecast.yaml</code></pre>

      <h3>Maintenance folders</h3>
      <ul>
        <li><strong><code>/backup/</code></strong> — Stable snapshots for quick rollback. Import from here only if you intend to revert.</li>
        <li><strong><code>/development/</code></strong> — Experimental drafts and test variants. Expect breaking changes. Do not use in production.</li>
      </ul>
    </section>

    <section id="privacy">
      <h2>Privacy</h2>
      <p>If <strong>AI rephrasing</strong> is enabled, the message is sent to your configured AI Task integration. Data handling follows that integration’s policy. Disable AI to keep processing local.</p>
    </section>

    <section id="support">
      <h2>Support &amp; contributions</h2>
      <p>Open issues and PRs on the repository. Keep YAML importable as a blueprint and describe user-visible changes clearly. Backward compatibility is appreciated where possible.</p>
      <div class="callout">
        Having trouble? In your issue, include your weather provider, a redacted screenshot of the weather entity’s attributes, and any Home Assistant log errors.
      </div>
    </section>

    <footer>
      &copy; Weather — Forecast TTS (AI Optional). This page is a single-file documentation intended to be committed as <code>docs.html</code> in the repository root.
      <span class="right"><a href="#top">Back to top</a></span>
    </footer>

  </div>
</main>

<script>
  // Copy buttons
  for (const btn of document.querySelectorAll(".copy")) {
    btn.addEventListener("click", async () => {
      const text = btn.getAttribute("data-copy");
      try { await navigator.clipboard.writeText(text); btn.textContent = "Copied"; setTimeout(()=>btn.textContent="Copy",1500); }
      catch(e){ btn.textContent="Copy failed"; setTimeout(()=>btn.textContent="Copy",1500); }
    });
  }
  // TOC active link highlight
  const headings = Array.from(document.querySelectorAll("main [id]"));
  const tocLinks = Array.from(document.querySelectorAll(".toc a"));
  const map = new Map(headings.map(h => [h.id, tocLinks.find(a => a.getAttribute("href")==="#"+h.id)]));
  const obs = new IntersectionObserver(entries=>{
    for(const e of entries){
      const id = e.target.id;
      const link = map.get(id);
      if(!link) continue;
      if(e.isIntersecting) { tocLinks.forEach(x=>x.classList.remove("active")); link.classList.add("active"); }
    }
  }, {rootMargin:"-40% 0px -55% 0px", threshold:[0,1]});
  headings.forEach(h=>obs.observe(h));
</script>

</body>
</html>
