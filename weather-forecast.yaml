blueprint:
  name: Weather — Forecast TTS (AI Optional)
  description: |
    ![Weather Forecast Alerts banner](https://raw.githubusercontent.com/zodyking/weather-forecast-alert-blueprint/main/imageforecast.png)

    Create a concise, engaging weather forecast announcement system in Home Assistant. This blueprint uses TTS to deliver TV-style updates via your speakers, pulling real-time data from daily and hourly forecasts. It highlights key details like temperature, conditions, humidity, and probable precipitation (rain or snow) with timing, daypart, and probability percentages.

    Optionally, integrate AI to rephrase messages for a more natural, professional tone—without altering any facts.

    **Key Features:**
    - Scheduled announcements (e.g., every few hours) or triggered by presence detection.
    - Alerts for current weather changes or upcoming precipitation.
    - Customizable thresholds for precip mentions, volume, voice, and more.

    **Tips for Setup:**
    - Select a weather entity supporting `weather.get_forecasts` (e.g., OpenWeatherMap for daily/hourly data).
    - Adjust "Precipitation probability threshold" and "Hours ahead" to fine-tune rain/snow alerts.
    - Disable "Use AI rewrite" for direct, unprocessed messages.
    - If audio starts late, bump up "TTS pre-roll (ms)" to wake devices properly.
  author: ZodyKing
  domain: automation
  source_url: https://github.com/zodyking/weather-forecast-alert-blueprint/blob/main/weather-forecast.yaml
  input:
    weather_data:
      name: Weather Data
      description: This section allows you to select the primary weather entity that supplies current conditions and forecast information for generating announcements. Choose an entity compatible with Home Assistant's weather integrations, such as OpenWeatherMap, which supports both daily and hourly forecasts essential for detailed weather reports.
      icon: mdi:asterisk
      collapsed: false
      inputs:
        weather_entity:
          name: Weather Entity
          description: The weather entity in Home Assistant that provides current conditions and forecast data, including support for hourly and daily forecasts from services like OpenWeatherMap or similar integrations.
          default: ''
          selector:
            entity:
              domain: weather
    tts_settings:
      name: TTS Settings
      description: Configure the Text-to-Speech (TTS) system here, including the engine for voice synthesis, media players for output, voice selection, volume control, and pre-roll delay to ensure smooth audio playback. These settings determine how announcements are spoken and delivered through your smart home devices.
      icon: mdi:account-voice
      collapsed: true
      inputs:
        tts_engine:
          name: TTS Engine
          description: The Text-to-Speech engine entity in Home Assistant responsible for generating spoken announcements, such as Piper TTS or Google Translate TTS.
          default: ''
          selector:
            entity:
              domain: tts
        speakers:
          name: Speakers
          description: The media player entities (e.g., speakers or smart displays) where the TTS announcements will be played. Multiple can be selected for broadcasting to different locations.
          default: []
          selector:
            entity:
              domain: media_player
              multiple: true
        voice:
          name: TTS Voice
          description: The voice option for the TTS engine. Specify the voice identifier compatible with your TTS service.
          default: "en_US-carlin-high"
          selector:
            text: {}
        volume_level:
          name: Volume Level
          description: The volume level for announcements (range 0 to 1, where 1 is maximum volume).
          default: 0.6
          selector:
            number:
              min: 0
              max: 1
              step: 0.01
              mode: slider
        preroll_ms:
          name: TTS Pre-roll (ms)
          description: Delay in milliseconds before speaking to allow speakers time to wake up and avoid audio cutoff.
          default: 150
          selector:
            number:
              min: 0
              max: 1000
              step: 50
              unit_of_measurement: ms
    ai_settings:
      name: AI Rephrasing (Optional)
      description: This optional section enables AI-based rephrasing of weather messages for a more natural, professional tone, similar to a TV meteorologist. Select an AI task entity, toggle rephrasing on or off, and customize the prompt to guide how the AI rewrites messages while strictly preserving all factual details.
      icon: mdi:robot
      collapsed: true
      inputs:
        ai_task_entity:
          name: AI Task Entity (Optional)
          description: An optional AI task entity (such as a Google AI integration) used to rephrase the weather messages for more natural-sounding TTS output. Leave blank if not using AI rephrasing.
          selector:
            entity:
              domain: ai_task
          default: ''
        use_ai_rewrite:
          name: Use AI Rewrite
          description: Toggle to enable AI rephrasing of the weather messages. If disabled, the raw crafted message will be spoken directly.
          default: false
          selector:
            boolean: {}
        ai_rewrite_prompt:
          name: AI Rewrite Prompt
          description: The prompt template used for AI rephrasing. Customize this to adjust how the AI rewrites the message while preserving facts.
          default: "Rewrite the message below for clear, natural TTS in a crisp TV-meteorologist voice.\nHard rules:\n- Preserve every fact exactly: all numbers, units (degrees, %, mph), times, day names, and weather terms.\n- Do not invent, omit, reorder, round, or restate any facts. Keep original sequencing of info.\n- Output RAW TEXT ONLY — no quotes, code fences, YAML/JSON, greetings, preambles, or sign-offs.\n- 2–4 short sentences, ≤55 words, plain vocabulary, no emojis, no hashtags, no ALL CAPS.\n- If precipitation timing/probability exists, mention it once using the same daypart/time and %; otherwise omit.\n- Keep symbols and formatting as given (%, AM/PM). If the input is “Forecast not available.” return it unchanged.\n"
          selector:
            text:
              multiline: true
    time_based_settings:
      name: Time-Based Announcements
      description: Set up scheduled weather announcements that occur at regular intervals throughout the day. This section includes toggles for enabling the feature, patterns for timing (e.g., every few hours), start and end times to restrict announcements to specific periods, and day-of-week selections to limit when they trigger.
      icon: mdi:clock-outline
      collapsed: true
      inputs:
        enable_time_based:
          name: Enable Time-Based Announcements
          description: Toggle to enable periodic weather announcements at set intervals during the day, based on the hour pattern, start time, and end time configurations.
          default: true
          selector:
            boolean: {}
        hour_pattern:
          name: Hour Pattern for Time-Based
          description: Specifies the interval for time-based announcements (e.g., '/3' for every 3 hours starting from the minute specified in the trigger). Only active if time-based announcements are enabled.
          default: /3
          selector:
            text: {}
        start_time:
          name: Start Time
          description: The earliest time of day (in HH:MM:SS format) when time-based announcements can occur. Announcements will only trigger between this and the end time.
          default: "08:00:00"
          selector:
            time: {}
        end_time:
          name: End Time
          description: The latest time of day (in HH:MM:SS format) when time-based announcements can occur. Announcements will only trigger between the start time and this time.
          default: "21:00:00"
          selector:
            time: {}
        days_of_week:
          name: Days of the Week
          description: Select the days of the week for time-based announcements to occur. If none selected, it will run every day.
          default: [mon, tue, wed, thu, fri, sat, sun]
          selector:
            select:
              multiple: true
              options:
                - label: Monday
                  value: mon
                - label: Tuesday
                  value: tue
                - label: Wednesday
                  value: wed
                - label: Thursday
                  value: thu
                - label: Friday
                  value: fri
                - label: Saturday
                  value: sat
                - label: Sunday
                  value: sun
    presence_settings:
      name: Presence-Triggered Announcements
      description: Enable weather updates triggered by presence detection, ideal for announcing forecasts upon arrival home. Configure sensors for detecting occupancy and toggle the feature to integrate with your smart home's motion or presence awareness.
      icon: mdi:motion-sensor
      collapsed: true
      inputs:
        enable_presence_triggered:
          name: Enable Presence-Triggered Announcements
          description: Toggle to enable weather announcements when presence is detected (e.g., someone arrives home), using the specified presence sensors.
          default: false
          selector:
            boolean: {}
        presence_sensors:
          name: Presence Sensors
          description: Binary sensor entities that detect presence (e.g., motion or occupancy sensors). Announcements trigger when these turn on if presence-triggered is enabled.
          default: []
          selector:
            entity:
              domain: binary_sensor
              multiple: true
    change_settings:
      name: Change Announcements
      description: Control alerts for real-time and impending weather changes. This includes toggles for notifying about current condition shifts (e.g., starting to rain) and upcoming events, with adjustable timing for advance warnings to prepare users for weather shifts.
      icon: mdi:weather-cloudy-alert
      collapsed: true
      inputs:
        enable_current_change_announce:
          name: Enable Current Change Announcements
          description: Toggle to enable announcements when the current weather condition changes (e.g., from sunny to rainy).
          default: true
          selector:
            boolean: {}
        enable_upcoming_change_announce:
          name: Enable Upcoming Change Announcements
          description: Toggle to enable announcements for upcoming weather changes, such as approaching precipitation, based on hourly forecasts and the minutes before announce setting.
          default: true
          selector:
            boolean: {}
        minutes_before_announce:
          name: Minutes Before Upcoming Announcement
          description: The number of minutes before an upcoming weather change (e.g., rain starting) that an announcement should be made. Used for upcoming change alerts.
          default: 30
          selector:
            number:
              min: 15
              max: 60
              step: 15
              unit_of_measurement: minutes
    precip_settings:
      name: Precipitation Settings
      description: Fine-tune how precipitation is handled in forecasts and alerts. Set thresholds for probability to avoid unnecessary mentions and define the forecast window in hours to focus on near-term or extended predictions.
      icon: mdi:weather-rainy
      collapsed: true
      inputs:
        precip_threshold:
          name: Precipitation Probability Threshold (%)
          description: The minimum precipitation probability percentage required to mention potential rain/snow in forecasts. Lower values include more mentions; higher values are more conservative.
          default: 30
          selector:
            number:
              min: 0
              max: 100
              unit_of_measurement: "%"
        hours_ahead:
          name: Hours Ahead for Forecast
          description: The number of hours ahead to check for precipitation in hourly forecasts. Adjust to control how far into the future precipitation mentions are considered.
          default: 24
          selector:
            number:
              min: 1
              max: 48
              unit_of_measurement: hours
trigger_variables:
  enable_time_based: !input enable_time_based
  enable_presence_triggered: !input enable_presence_triggered
  enable_current_change_announce: !input enable_current_change_announce
  enable_upcoming_change_announce: !input enable_upcoming_change_announce
  minutes_before_announce: !input minutes_before_announce
trigger:
  - trigger: time_pattern
    hours: !input hour_pattern
    minutes: "3"
    id: time_based
  - trigger: state
    entity_id: !input presence_sensors
    to: "on"
    id: presence_arrival
  - trigger: state
    entity_id: !input weather_entity
    id: current_change
  - trigger: time_pattern
    minutes: "/5"
    id: upcoming_change
condition:
  - condition: or
    conditions:
      - condition: and
        conditions:
          - condition: trigger
            id: time_based
          - condition: time
            after: !input start_time
            before: !input end_time
          - condition: template
            value_template: "{{ enable_time_based }}"
          - "{{ not days_of_week or now().strftime('%a').lower()[:3] in days_of_week }}"
      - condition: and
        conditions:
          - condition: trigger
            id: presence_arrival
          - condition: template
            value_template: "{{ enable_presence_triggered }}"
      - condition: and
        conditions:
          - condition: trigger
            id: current_change
          - condition: template
            value_template: "{{ enable_current_change_announce }}"
      - condition: and
        conditions:
          - condition: trigger
            id: upcoming_change
          - condition: template
            value_template: "{{ enable_upcoming_change_announce }}"
action:
  - variables:
      key: !input weather_entity
      spoken: ""
  - choose:
      - conditions:
          - condition: or
            conditions:
              - condition: trigger
                id: time_based
              - condition: trigger
                id: presence_arrival
        sequence:
          - action: weather.get_forecasts
            target:
              entity_id: !input weather_entity
            data:
              type: daily
            response_variable: d
          - action: weather.get_forecasts
            target:
              entity_id: !input weather_entity
            data:
              type: hourly
            response_variable: h
          - variables:
              precip_threshold: !input precip_threshold
              hours_ahead: !input hours_ahead
              now_hour: "{{ now().hour }}"
              day_name: "{{ (now() | as_timestamp | timestamp_custom('%A', true)) }}"
              greeting: "{% if 5 <= now_hour <= 11 %}Good morning{% elif 12 <= now_hour <= 17 %} Good afternoon{% else %}Good evening{% endif %}"
              now_temp: "{{ state_attr(key,'temperature') }}"
              now_hum: "{{ state_attr(key,'humidity') }}"
              now_cond_h: "{% set s = (states(key) or '') | lower %} {% set s = s | replace('_',' ') | replace('-',' ') %} {% set s = s | replace('partlycloudy','partly cloudy') | replace('clearnight','clear night') %} {{ s | trim }}"
              daily_list: "{{ d.get(key,{}).get('forecast',[]) }}"
              today: "{{ daily_list[0] if daily_list|length>0 else dict() }}"
              high: "{{ today.get('temperature') }}"
              low: "{{ today.get('templow', today.get('temperature_low')) }}"
              today_cond_h: "{% set raw = (today.get('condition') or states(key) or '') | lower %} {% set s = raw | replace('_',' ') | replace('-',' ') %} {% set s = s | replace('partlycloudy','partly cloudy') | replace('clearnight','clear night') %} {{ s | trim }}"
              now_norm: "{{ now_cond_h | replace(' ','') }}"
              today_norm: "{{ today_cond_h | replace(' ','') }}"
              mention_expect: "{{ today_cond_h != '' and today_norm != now_norm }}"
              hourly_list: "{{ h.get(key,{}).get('forecast',[]) }}"
              next_hours: "{{ hourly_list[:hours_ahead] if hourly_list else [] }}"
              hits: "{{ (next_hours | selectattr('precipitation_probability','defined') | selectattr('precipitation_probability','ge', precip_threshold) | list) }}"
              first_hit: "{{ hits[0] if hits|length>0 else dict() }}"
              hit_pp: "{{ first_hit.get('precipitation_probability') }}"
              hit_cond_h: "{% set raw = (first_hit.get('condition','') | lower) %} {% set s = raw | replace('_',' ') | replace('-',' ') %} {% set s = s | replace('partlycloudy','partly cloudy') | replace('clearnight','clear night') %} {{ s | trim }}"
              hit_ts: "{% set t = none %} {% if first_hit.get('datetime') %} {% set t = as_datetime(first_hit.get('datetime')) | as_timestamp %} {% endif %} {{ t }}"
              hit_clock: "{% set out = '' %} {% if hit_ts is not none %} {% set out = (hit_ts | timestamp_custom('%I %p', true)) | replace(' 0',' ') %} {% endif %} {{ out }}"
              hit_hour_num: "{% set out = 0 %} {% if hit_ts is not none %} {% set out = (hit_ts | timestamp_custom('%H', true)) | int %} {% endif %} {{ out }}"
              hit_daypart: "{% set hnum = hit_hour_num %} {% if 5 <= hnum <= 11 %}this morning{% elif 12 <= hnum <= 17 %}this afternoon {% elif 18 <= hnum <= 22 %}this evening{% else %}overnight{% endif %}"
              precip_kind: "{% if 'snow' in hit_cond_h %}snow{% elif 'sleet' in hit_cond_h or 'hail' in hit_cond_h %}mixed precipitation {% elif hit_cond_h %}rain{% else %}precipitation{% endif %}"
              msg: "{% set p = [] %} {% set p = p + [greeting ~ '! ' ~ day_name ~ \"'s forecast.\"] %} {% set now_bits = [] %} {% if now_cond_h %}{% set now_bits = now_bits + [now_cond_h | capitalize] %}{% endif %} {% if now_temp is not none %}{% set now_bits = now_bits + [ (now_temp | round(0) ~ ' degrees') ] %}{% endif %} {% if now_hum is not none %}{% set now_bits = now_bits + [ ('humidity ' ~ now_hum ~ '%') ] %}{% endif %} {% if now_bits | length > 0 %}{% set p = p + ['Right now: ' ~ (now_bits | join(', ')) ~ '.'] %}{% endif %} {% set today_bits = [] %} {% if mention_expect %}{% set today_bits = today_bits + ['Expect ' ~ today_cond_h ~ '.'] %}{% endif %} {% if high is not none %}{% set today_bits = today_bits + ['High ' ~ (high | round(0)) ~ ' degrees.'] %}{% endif %} {% if low is not none %}{% set today_bits = today_bits + ['Low ' ~ (low | round(0)) ~ ' degrees.'] %}{% endif %} {% if today_bits | length > 0 %}{% set p = p + [ today_bits | join(' ') ] %}{% endif %} {% if hits | length > 0 and hit_pp is not none %} {% set phr = precip_kind ~ ' chances ' ~ hit_daypart %} {% if hit_clock %}{% set phr = phr ~ ' around ' ~ hit_clock %}{% endif %} {% set phr = phr ~ ': ' ~ (hit_pp | int) ~ '%.' %} {% set p = p + [ phr ] %} {% endif %} {{ p | join(' ') if p|length > 0 else 'Forecast not available.' }}"
              i_ai: !input use_ai_rewrite
              i_ai_task: !input ai_task_entity
              i_ai_text: !input ai_rewrite_prompt
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ i_ai and (i_ai_task | default('') | string) != '' }}"
                sequence:
                  - action: ai_task.generate_data
                    data:
                      entity_id: "{{ i_ai_task }}"
                      task_name: "weather message"
                      instructions: "{{ i_ai_text }}\nMessage:\n\"{{ msg | replace('\"','\\\\\"') }}\""
                    response_variable: aimsg
                  - variables:
                      spoken: "{{ aimsg.data | default(msg) }}"
            default:
              - variables:
                  spoken: "{{ msg }}"
      - conditions:
          - condition: trigger
            id: current_change
        sequence:
          - variables:
              now_cond_raw: "{{ trigger.to_state.state | lower }}"
              now_cond_h: "{% set s = now_cond_raw %} {% set s = s | replace('_',' ') | replace('-',' ') %} {% set s = s | replace('partlycloudy','partly cloudy') | replace('clearnight','clear night') %} {{ s | trim }}"
              from_cond_raw: "{{ trigger.from_state.state | default('unknown') | lower }}"
              is_change: "{{ now_cond_raw != from_cond_raw }}"
              msg: "Weather update: conditions have changed to {{ now_cond_h }}."
              i_ai: !input use_ai_rewrite
              i_ai_task: !input ai_task_entity
              i_ai_text: !input ai_rewrite_prompt
          - if: "{{ is_change }}"
            then:
              - choose:
                  - conditions:
                      - condition: template
                        value_template: "{{ i_ai and (i_ai_task | default('') | string) != '' }}"
                    sequence:
                      - action: ai_task.generate_data
                        data:
                          entity_id: "{{ i_ai_task }}"
                          task_name: "weather message"
                          instructions: "{{ i_ai_text }}\nMessage:\n\"{{ msg | replace('\"','\\\\\"') }}\""
                        response_variable: aimsg
                      - variables:
                          spoken: "{{ aimsg.data | default(msg) }}"
                default:
                  - variables:
                      spoken: "{{ msg }}"
      - conditions:
          - condition: trigger
            id: upcoming_change
        sequence:
          - action: weather.get_forecasts
            target:
              entity_id: !input weather_entity
            data:
              type: hourly
            response_variable: h
          - variables:
              hourly_list: "{{ h.get(key,{}).get('forecast',[]) }}"
              upcoming: "{{ hourly_list | selectattr('datetime','gt', now().isoformat()) | sort(attribute='datetime') | list }}"
              next_hit: "{{ upcoming[0] if upcoming else {} }}"
              next_dt: "{{ next_hit.get('datetime') }}"
              next_ts: "{{ as_timestamp(next_dt) if next_dt else none }}"
              min_to: "{{ ((next_ts - as_timestamp(now())) / 60) | round(0) if next_ts else 0 }}"
              next_cond_raw: "{{ next_hit.get('condition','') | lower }}"
              next_cond_h: "{% set s = next_cond_raw %} {% set s = s | replace('_',' ') | replace('-',' ') %} {% set s = s | replace('partlycloudy','partly cloudy') | replace('clearnight','clear night') %} {{ s | trim }}"
              now_cond_raw: "{{ states(key) | lower }}"
              now_is_precip: "{{ 'rain' in now_cond_raw or 'snow' in now_cond_raw or 'hail' in now_cond_raw or 'pour' in now_cond_raw or 'lightning' in now_cond_raw }}"
              next_is_precip: "{{ 'rain' in next_cond_raw or 'snow' in next_cond_raw or 'hail' in next_cond_raw or 'pour' in next_cond_raw or 'lightning' in next_cond_raw }}"
              should_announce: "{{ next_ts is not none and next_is_precip and not now_is_precip and 0 < min_to <= minutes_before_announce }}"
              precip_kind: "{% if 'snow' in next_cond_h %}snow{% elif 'sleet' in next_cond_h or 'hail' in next_cond_h %}mixed precipitation {% elif next_cond_h %}rain{% else %}precipitation{% endif %}"
              msg: "Weather alert: {{ precip_kind }} expected in about {{ min_to }} minutes."
              i_ai: !input use_ai_rewrite
              i_ai_task: !input ai_task_entity
              i_ai_text: !input ai_rewrite_prompt
          - if: "{{ should_announce }}"
            then:
              - choose:
                  - conditions:
                      - condition: template
                        value_template: "{{ i_ai and (i_ai_task | default('') | string) != '' }}"
                    sequence:
                      - action: ai_task.generate_data
                        data:
                          entity_id: "{{ i_ai_task }}"
                          task_name: "weather message"
                          instructions: "{{ i_ai_text }}\nMessage:\n\"{{ msg | replace('\"','\\\\\"') }}\""
                        response_variable: aimsg
                      - variables:
                          spoken: "{{ aimsg.data | default(msg) }}"
                default:
                  - variables:
                      spoken: "{{ msg }}"
  - if: "{{ spoken | default('') | trim != '' }}"
    then:
      - action: media_player.volume_set
        target:
          entity_id: !input speakers
        data:
          volume_level: !input volume_level
      - repeat:
          for_each: !input speakers
          sequence:
            - delay:
                milliseconds: !input preroll_ms
            - action: tts.speak
              target:
                entity_id: !input tts_engine
              data:
                cache: true
                media_player_entity_id: "{{ repeat.item }}"
                message: "{{ spoken | trim }}"
                options:
                  voice: !input voice
mode: single
